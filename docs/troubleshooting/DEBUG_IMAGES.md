# 图片搜索调试指南

## 如何查看日志

### 1. 服务器端日志（API路由）

服务器端日志会显示在运行 `npm run dev` 或 `npm start` 的**终端窗口**中。

#### 查看位置：
- 如果你在命令行运行项目，日志会直接显示在终端
- 如果使用 VS Code，查看"终端"面板（Terminal）
- 如果使用其他IDE，查看运行项目的终端窗口

#### 日志格式：

**成功时：**
```
✅ AI搜索成功：为"宽窄巷子"找到 3/5 张有效图片
[图片 1] ✓ 接受：包含关键词匹配
[图片 2] ✓ 接受：包含旅游关键词或有效图片URL
```

**失败时：**
```
❌ AI搜索失败：为"宽窄巷子"返回了 5 张图片，但全部被过滤
📍 景点名称：宽窄巷子

📋 被过滤的图片详情：
  图片 1: { url: 'https://...', description: '...' }
  图片 2: { url: 'https://...', description: '...' }
```

**每个图片的过滤原因：**
```
[图片 1] ✗ 被过滤：未找到关键词且不符合放宽条件
[图片 2] ✗ 被过滤：占位符或无效图片
[图片 3] ✗ 被过滤：无效的URL格式
```

### 2. 客户端日志（浏览器控制台）

客户端日志会显示在浏览器的**开发者工具控制台**中。

#### 如何打开浏览器控制台：

**Chrome/Edge:**
- 按 `F12` 或 `Ctrl+Shift+I` (Windows/Linux)
- 按 `Cmd+Option+I` (Mac)
- 右键点击页面 → "检查" → 切换到"Console"标签

**Firefox:**
- 按 `F12` 或 `Ctrl+Shift+K` (Windows/Linux)
- 按 `Cmd+Option+K` (Mac)

**Safari:**
- 需要先启用开发者菜单：偏好设置 → 高级 → 勾选"在菜单栏中显示开发菜单"
- 然后按 `Cmd+Option+C`

#### 客户端日志格式：

```
[客户端] ✅ 图片搜索API成功：为"宽窄巷子"找到 3 张图片
[客户端] ❌ AI搜索返回了图片，但全部未通过相关性验证：宽窄巷子
[客户端] 💡 提示：查看服务器终端日志了解详细过滤原因
```

## 常见问题排查

### 问题1：所有图片都被过滤

**查看服务器日志，寻找：**
- `[图片 X] ✗ 被过滤：...` 这样的日志
- 每个图片被过滤的具体原因

**可能的原因：**
1. **无效URL格式** - AI返回的URL格式不正确
2. **占位符图片** - URL中包含 placeholder、default 等关键词
3. **未找到关键词** - URL和描述中都不包含景点名称的关键词
4. **不符合放宽条件** - 既没有旅游关键词，也不是有效的图片URL

### 问题2：Wikipedia一直超时

**日志显示：**
```
Wikipedia search timeout, skipping (will use other sources)
```

**解决方案：**
- 这是正常的，Wikipedia可能被墙或网络较慢
- 系统会自动使用AI搜索和其他图片源
- 如果配置了Unsplash、Pexels、Google或Bing API，它们会继续工作

### 问题3：AI搜索返回空数组

**查看服务器日志：**
```
AI did not return valid JSON
```
或
```
AI returned 0 images
```

**可能的原因：**
1. AI API配置错误
2. AI返回的格式不是JSON
3. AI确实找不到相关图片

### 问题4：图片显示但不够相关

**查看服务器日志中的关键词匹配：**
```
[图片 1] ✓ 接受：包含关键词匹配
matchedKeywords: ['宽窄', '巷子']
```

如果匹配的关键词太少或太短，可能需要进一步放宽验证规则。

## 调试技巧

### 1. 启用详细日志

所有日志已经默认启用，无需额外配置。

### 2. 过滤日志

在浏览器控制台中，可以使用过滤器：
- 输入 `[客户端]` 只查看客户端日志
- 输入 `✅` 只查看成功日志
- 输入 `❌` 只查看失败日志

### 3. 保存日志

**浏览器控制台：**
- 右键点击日志 → "Save as..."
- 或使用控制台的导出功能

**服务器终端：**
- 使用 `npm run dev > logs.txt 2>&1` 保存所有日志到文件
- 或使用 `tee` 命令同时显示和保存

## 下一步

如果看到图片被过滤，根据日志中的原因：
1. 如果是URL格式问题，检查AI返回的URL
2. 如果是关键词匹配问题，可以进一步放宽验证规则
3. 如果是占位符问题，需要改进AI的prompt

查看完日志后，可以告诉我具体看到了什么错误，我会帮你进一步优化。

